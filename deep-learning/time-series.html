
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Time series &#8212; DL-learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'deep-learning/time-series';</script>
    <link rel="canonical" href="https://llzccz.github.io/deep-learning/deep-learning/time-series.html" />
    <link rel="icon" href="../_static/fav.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Autoencoder" href="autoencoder.html" />
    <link rel="prev" title="Bidirectional RNN" href="rnn/bi-rnn.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="DL-learning - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="DL-learning - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">DEEP LEARNING</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dl-overview.html">Intro to Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="nn.html">Neural Networks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="cnn/cnn.html">Convolutional Neural Networks</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="cnn/cnn-vgg.html">Stylenet / Neural-Style</a></li>
<li class="toctree-l2"><a class="reference internal" href="cnn/cnn-deepdream.html">Deepdream in TensorFlow</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="rnn/rnn.html">Recurrent Neural Networks</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="rnn/lstm.html">Long-short term memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="rnn/bi-rnn.html">Bidirectional RNN</a></li>
</ul>
</li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Time series</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoencoder.html">Autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="object-detection.html">Object detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="image-classification.html">Image classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="image-segmentation.html">Image segmentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="nlp/nlp.html">Natural Language Processing</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="nlp/text-preprocessing.html">Text Preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="nlp/text-representation.html">Word embedding</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gan.html">Generative adversarial networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="difussion-model.html">Diffusion Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="dqn.html">Deep Q-learning</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ASSIGNMENTS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../assignments/google-stock-price-prediction-rnn.html">Google Stock Price Prediction RNN</a></li>

<li class="toctree-l1"><a class="reference internal" href="../assignments/bitcoin-lstm-model-with-tweet-volume-and-sentiment.html">Bitcoin LSTM Model with Tweet Volume and Sentiment</a></li>

<li class="toctree-l1"><a class="reference internal" href="../assignments/beginner-guide-to-text-preprocessing.html">Beginner’s Guide to Text Pre-Processing</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/llzccz/deep-learning/master?urlpath=tree/deep-learning/time-series.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/llzccz/deep-learning/blob/master/deep-learning/time-series.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/llzccz/deep-learning" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/llzccz/deep-learning/edit/main/deep-learning/time-series.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/llzccz/deep-learning/issues/new?title=Issue%20on%20page%20%2Fdeep-learning/time-series.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/deep-learning/time-series.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Time series</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overiew">Overiew</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-a-time-series">What is a Time Series?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-regression-with-time-series">Linear Regression with Time Series</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-step-features">Time-step features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-features">Lag features</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-tunnel-traffic">Example - Tunnel Traffic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-step-feature">Time-step feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-feature">Lag feature</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-with-deep-learning">Forecasting With Deep Learning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-the-forecasting-task">Defining the Forecasting Task</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-data-for-forecasting">Preparing Data for Forecasting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multistep-forecasting-strategies">Multistep Forecasting Strategies</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multioutput-model">Multioutput model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-strategy">Direct strategy</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-strategy">Recursive strategy</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dirrec-strategy">DirRec strategy</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-flu-trends">Example - Flu Trends</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Multioutput model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Direct strategy</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#your-turn">Your turn! 🚀</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgments">Acknowledgments</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install the necessary dependencies</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span> 
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--quiet<span class="w"> </span>pandas<span class="w"> </span>scikit-learn<span class="w"> </span>numpy<span class="w"> </span>matplotlib<span class="w"> </span>jupyterlab_myst<span class="w"> </span>ipython<span class="w"> </span>requests
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Ignoring invalid distribution -ytest (c:\users\victor\anaconda3\envs\open-machine-learning-jupyter-book\lib\site-packages)
WARNING: Ignoring invalid distribution -ytest (c:\users\victor\anaconda3\envs\open-machine-learning-jupyter-book\lib\site-packages)
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="time-series">
<h1>Time series<a class="headerlink" href="#time-series" title="Link to this heading">#</a></h1>
<section id="overiew">
<h2>Overiew<a class="headerlink" href="#overiew" title="Link to this heading">#</a></h2>
<p>Time series forecasting is a broad field with a long history and forcasting is perhaps the most common application in the real world. Businesses forecast product demand, governments forecast economic and population growth, meteorologists forecast the weather. The understanding of things to come is a pressing need across science, government, and industry (not to mention our personal lives!), and practitioners in these fields are increasingly applying machine learning to address this need.</p>
<p>After finishing this course, you’ll know how to:</p>
<ul class="simple">
<li><p>engineer features to model the major time series components (trends, seasons, and cycles),</p></li>
<li><p>visualize time series with many kinds of time series plots,</p></li>
<li><p>create forecasting hybrids that combine the strengths of complementary models, and</p></li>
<li><p>adapt machine learning methods to a variety of forecasting tasks.</p></li>
</ul>
</section>
<section id="what-is-a-time-series">
<h2>What is a Time Series?<a class="headerlink" href="#what-is-a-time-series" title="Link to this heading">#</a></h2>
<p>The basic object of forecasting is the time series, which is a set of observations recorded over time. In forecasting applications, the observations are typically recorded with a regular frequency, like daily or monthly.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>kaggle kernels output ryanholbrook/linear-regression-with-time-series -p /path/to/dest
<a class="reference external" href="https://www.kaggle.com/competitions/store-sales-time-series-forecasting">https://www.kaggle.com/competitions/store-sales-time-series-forecasting</a></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://static-1300131294.cos.ap-shanghai.myqcloud.com/data/book_sales.csv&quot;</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
    <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Paperback&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Hardcover</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-04-01</th>
      <td>139</td>
    </tr>
    <tr>
      <th>2000-04-02</th>
      <td>128</td>
    </tr>
    <tr>
      <th>2000-04-03</th>
      <td>172</td>
    </tr>
    <tr>
      <th>2000-04-04</th>
      <td>139</td>
    </tr>
    <tr>
      <th>2000-04-05</th>
      <td>191</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This series records the number of hardcover book sales at a retail store over 30 days. Notice that we have a single column of observations <span class="math notranslate nohighlight">\(Hardcover\)</span> with a time index <span class="math notranslate nohighlight">\(Date\)</span>.</p>
</section>
<section id="linear-regression-with-time-series">
<h2>Linear Regression with Time Series<a class="headerlink" href="#linear-regression-with-time-series" title="Link to this heading">#</a></h2>
<p>For the first part of this course, we’ll use the linear regression algorithm to construct forecasting models. Linear regression is widely used in practice and adapts naturally to even complex forecasting tasks.</p>
<p>The linear regression algorithm learns how to make a weighted sum from its input features. For two features, we would have:</p>
<p><span class="math notranslate nohighlight">\(target = weight_1 * feature_1 + weight_2 * feature_2 + bias\)</span></p>
<p>During training, the regression algorithm learns values for the parameters <span class="math notranslate nohighlight">\(weight_1\)</span>, <span class="math notranslate nohighlight">\(weight_2\)</span>, and <span class="math notranslate nohighlight">\(bias\)</span> that best fit the <span class="math notranslate nohighlight">\(target\)</span>. (This algorithm is often called ordinary least squares since it chooses values that minimize the squared error between the target and the predictions.) The weights are also called regression coefficients and the bias is also called the intercept because it tells you where the graph of this function crosses the y-axis.</p>
<section id="time-step-features">
<h3>Time-step features<a class="headerlink" href="#time-step-features" title="Link to this heading">#</a></h3>
<p>There are two kinds of features unique to time series: time-step features and lag features.</p>
<p>Time-step features are features we can derive directly from the time index. The most basic time-step feature is the time dummy, which counts off time steps in the series from beginning to end.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Hardcover</th>
      <th>Time</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-04-01</th>
      <td>139</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2000-04-02</th>
      <td>128</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2000-04-03</th>
      <td>172</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2000-04-04</th>
      <td>139</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2000-04-05</th>
      <td>191</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Linear regression with the time dummy produces the model:</p>
<p><span class="math notranslate nohighlight">\(target = weight * time + bias\)</span></p>
<p>The time dummy then lets us fit curves to time series in a time plot, where Time forms the x-axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-whitegrid&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span>
    <span class="s2">&quot;figure&quot;</span><span class="p">,</span>
    <span class="n">autolayout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="n">titlesize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
    <span class="n">titleweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span>
    <span class="s2">&quot;axes&quot;</span><span class="p">,</span>
    <span class="n">labelweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">labelsize</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">,</span>
    <span class="n">titleweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">titlesize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">titlepad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;Hardcover&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.75&#39;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Hardcover&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.25&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time Plot of Hardcover Sales&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/ad09a7919cb8ed742e7a6dcc0595c5d61ca642fa62eda68669ad19f19f1477f6.png"><img alt="../_images/ad09a7919cb8ed742e7a6dcc0595c5d61ca642fa62eda68669ad19f19f1477f6.png" src="../_images/ad09a7919cb8ed742e7a6dcc0595c5d61ca642fa62eda68669ad19f19f1477f6.png" style="width: 1089px; height: 390px;" /></a>
</div>
</div>
<p>Time-step features let you model time dependence. A series is time dependent if its values can be predicted from the time they occured. In the Hardcover Sales series, we can predict that sales later in the month are generally higher than sales earlier in the month.</p>
</section>
<section id="lag-features">
<h3>Lag features<a class="headerlink" href="#lag-features" title="Link to this heading">#</a></h3>
<p>To make a lag feature we shift the observations of the target series so that they appear to have occured later in time. Here we’ve created a 1-step lag feature, though shifting by multiple steps is possible too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Lag_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Hardcover&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Hardcover&#39;</span><span class="p">,</span> <span class="s1">&#39;Lag_1&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Hardcover</th>
      <th>Lag_1</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-04-01</th>
      <td>139</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-04-02</th>
      <td>128</td>
      <td>139.0</td>
    </tr>
    <tr>
      <th>2000-04-03</th>
      <td>172</td>
      <td>128.0</td>
    </tr>
    <tr>
      <th>2000-04-04</th>
      <td>139</td>
      <td>172.0</td>
    </tr>
    <tr>
      <th>2000-04-05</th>
      <td>191</td>
      <td>139.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Linear regression with a lag feature produces the model: <span class="math notranslate nohighlight">\(target = weight * lag + bias\)</span>. So lag features let us fit curves to lag plots where each observation in a series is plotted against the previous observation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Lag_1&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Hardcover&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.25&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lag Plot of Hardcover Sales&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/8184145699fddffd9c50a822f6dc4dbb12a70070ee9606394a573dcc7ea2e588.png"><img alt="../_images/8184145699fddffd9c50a822f6dc4dbb12a70070ee9606394a573dcc7ea2e588.png" src="../_images/8184145699fddffd9c50a822f6dc4dbb12a70070ee9606394a573dcc7ea2e588.png" style="width: 370px; height: 390px;" /></a>
</div>
</div>
<p>You can see from the lag plot that sales on one day <span class="math notranslate nohighlight">\((Hardcover)\)</span> are correlated with sales from the previous day <span class="math notranslate nohighlight">\((Lag_1)\)</span>. When you see a relationship like this, you know a lag feature will be useful.</p>
<p>More generally, lag features let you model serial dependence. A time series has serial dependence when an observation can be predicted from previous observations. In Hardcover Sales, we can predict that high sales on one day usually mean high sales the next day.</p>
<p>Adapting machine learning algorithms to time series problems is largely about feature engineering with the time index and lags. For most of the course, we use linear regression for its simplicity, but these features will be useful whichever algorithm you choose for your forecasting task.</p>
</section>
</section>
<section id="example-tunnel-traffic">
<h2>Example - Tunnel Traffic<a class="headerlink" href="#example-tunnel-traffic" title="Link to this heading">#</a></h2>
<p>Tunnel Traffic is a time series describing the number of vehicles traveling through the Baregg Tunnel in Switzerland each day from November 2003 to November 2005. In this example, we’ll get some practice applying linear regression to time-step features and lag features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">simplefilter</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># ignore warnings to clean up output cells</span>

<span class="c1"># Set Matplotlib defaults</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-whitegrid&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span> <span class="n">autolayout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span>
    <span class="s2">&quot;axes&quot;</span><span class="p">,</span>
    <span class="n">labelweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">labelsize</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">,</span>
    <span class="n">titleweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">titlesize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">titlepad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.75&quot;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;.-&quot;</span><span class="p">,</span>
    <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;0.25&quot;</span><span class="p">,</span>
    <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;0.25&quot;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;


<span class="c1"># Load Tunnel Traffic dataset</span>
<span class="n">cloud_link</span> <span class="o">=</span> <span class="s2">&quot;https://static-1300131294.cos.ap-shanghai.myqcloud.com/data/tunnel.csv&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cloud_link</span><span class="p">)</span>
<span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">tunnel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Day&quot;</span><span class="p">])</span>
<span class="c1"># Create a time series in Pandas by setting the index to a date</span>
<span class="c1"># column. We parsed &quot;Day&quot; as a date type by using `parse_dates` when</span>
<span class="c1"># loading the data.</span>
<span class="n">tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Day&quot;</span><span class="p">)</span>

<span class="c1"># By default, Pandas creates a `DatetimeIndex` with dtype `Timestamp`</span>
<span class="c1"># (equivalent to `np.datetime64`, representing a time series as a</span>
<span class="c1"># sequence of measurements taken at single moments. A `PeriodIndex`,</span>
<span class="c1"># on the other hand, represents a time series as a sequence of</span>
<span class="c1"># quantities accumulated over periods of time. Periods are often</span>
<span class="c1"># easier to work with, so that&#39;s what we&#39;ll use in this course.</span>
<span class="n">tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">to_period</span><span class="p">()</span>

<span class="n">tunnel</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NumVehicles</th>
    </tr>
    <tr>
      <th>Day</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2003-11-01</th>
      <td>103536</td>
    </tr>
    <tr>
      <th>2003-11-02</th>
      <td>92051</td>
    </tr>
    <tr>
      <th>2003-11-03</th>
      <td>100795</td>
    </tr>
    <tr>
      <th>2003-11-04</th>
      <td>102352</td>
    </tr>
    <tr>
      <th>2003-11-05</th>
      <td>106569</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="time-step-feature">
<h3>Time-step feature<a class="headerlink" href="#time-step-feature" title="Link to this heading">#</a></h3>
<p>Provided the time series doesn’t have any missing dates, we can create a time dummy by counting out the length of the series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tunnel</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NumVehicles</th>
      <th>Time</th>
    </tr>
    <tr>
      <th>Day</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2003-11-01</th>
      <td>103536</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2003-11-02</th>
      <td>92051</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2003-11-03</th>
      <td>100795</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2003-11-04</th>
      <td>102352</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2003-11-05</th>
      <td>106569</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The procedure for fitting a linear regression model follows the standard steps for scikit-learn.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="c1"># Training data</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]]</span>  <span class="c1"># features</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;NumVehicles&#39;</span><span class="p">]</span>  <span class="c1"># target</span>

<span class="c1"># Train the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Store the fitted values as a time series with the same time index as</span>
<span class="c1"># the training data</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The model actually created is (approximately): <span class="math notranslate nohighlight">\(Vehicles = 22.5 * Time + 98176\)</span>. Plotting the fitted values over time shows us how fitting linear regression to the time dummy creates the trend line defined by this equation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_params</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time Plot of Tunnel Traffic&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/4831330a5f039f4394c3ea8a3adfd049ec5a69a83e65c7893d292d2072ff832c.png"><img alt="../_images/4831330a5f039f4394c3ea8a3adfd049ec5a69a83e65c7893d292d2072ff832c.png" src="../_images/4831330a5f039f4394c3ea8a3adfd049ec5a69a83e65c7893d292d2072ff832c.png" style="width: 1089px; height: 390px;" /></a>
</div>
</div>
</section>
<section id="lag-feature">
<h3>Lag feature<a class="headerlink" href="#lag-feature" title="Link to this heading">#</a></h3>
<p>Pandas provides us a simple method to lag a series, the <span class="math notranslate nohighlight">\(shift\)</span> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Lag_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NumVehicles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NumVehicles</th>
      <th>Time</th>
      <th>Lag_1</th>
    </tr>
    <tr>
      <th>Day</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2003-11-01</th>
      <td>103536</td>
      <td>0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2003-11-02</th>
      <td>92051</td>
      <td>1</td>
      <td>103536.0</td>
    </tr>
    <tr>
      <th>2003-11-03</th>
      <td>100795</td>
      <td>2</td>
      <td>92051.0</td>
    </tr>
    <tr>
      <th>2003-11-04</th>
      <td>102352</td>
      <td>3</td>
      <td>100795.0</td>
    </tr>
    <tr>
      <th>2003-11-05</th>
      <td>106569</td>
      <td>4</td>
      <td>102352.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>When creating lag features, we need to decide what to do with the missing values produced. Filling them in is one option, maybe with 0.0 or “backfilling” with the first known value. Instead, we’ll just drop the missing values, making sure to also drop values in the target from corresponding dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Lag_1&#39;</span><span class="p">]]</span>
<span class="n">X</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># drop missing values in the feature set</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;NumVehicles&#39;</span><span class="p">]</span>  <span class="c1"># create the target</span>
<span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>  <span class="c1"># drop corresponding values in target</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The lag plot shows us how well we were able to fit the relationship between the number of vehicles one day and the number the previous day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;Lag_1&#39;</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.25&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;Lag_1&#39;</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NumVehicles&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Lag_1&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lag Plot of Tunnel Traffic&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/492b0d78f3c41dd45ba2944f48d94f1c8614a9a8f19fabcf58e1cc6fc6bbe547.png"><img alt="../_images/492b0d78f3c41dd45ba2944f48d94f1c8614a9a8f19fabcf58e1cc6fc6bbe547.png" src="../_images/492b0d78f3c41dd45ba2944f48d94f1c8614a9a8f19fabcf58e1cc6fc6bbe547.png" style="width: 405px; height: 389px;" /></a>
</div>
</div>
<p>What does this prediction from a lag feature mean about how well we can predict the series across time? The following time plot shows us how our forecasts now respond to the behavior of the series in the recent past.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_params</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/72cdf211744703087e3a8aed3629754064f7f74db1c1db0ad8c192b7f19eeccb.png"><img alt="../_images/72cdf211744703087e3a8aed3629754064f7f74db1c1db0ad8c192b7f19eeccb.png" src="../_images/72cdf211744703087e3a8aed3629754064f7f74db1c1db0ad8c192b7f19eeccb.png" style="width: 1089px; height: 390px;" /></a>
</div>
</div>
<p>The best time series models will usually include some combination of time-step features and lag features. Over the next few lessons, we’ll learn how to engineer features modeling the most common patterns in time series using the features from this lesson as a starting point.</p>
</section>
</section>
<section id="forecasting-with-deep-learning">
<h2>Forecasting With Deep Learning<a class="headerlink" href="#forecasting-with-deep-learning" title="Link to this heading">#</a></h2>
<section id="defining-the-forecasting-task">
<h3>Defining the Forecasting Task<a class="headerlink" href="#defining-the-forecasting-task" title="Link to this heading">#</a></h3>
<p>There are two things to establish before designing a forecasting model:</p>
<ul class="simple">
<li><p>what information is available at the time a forecast is made (features),</p></li>
<li><p>the time period during which you require forecasted values (target).</p></li>
</ul>
<p>The forecast origin is time at which you are making a forecast. Practically, you might consider the forecast origin to be the last time for which you have training data for the time being predicted. Everything up to he origin can be used to create features.</p>
<p>The forecast horizon is the time for which you are making a forecast. We often describe a forecast by the number of time steps in its horizon: a “1-step” forecast or “5-step” forecast, say. The forecast horizon describes the target.</p>
<figure class="align-default" id="def">
<a class="bg-white mb-1 reference internal image-reference" href="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/01_def.png"><img alt="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/01_def.png" class="bg-white mb-1" src="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/01_def.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 9 </span><span class="caption-text">A three-step forecast horizon with a two-step lead time, using four lag features. The figure represents what would be a single row of training data – data for a single prediction, in other words.</span><a class="headerlink" href="#def" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The time between the origin and the horizon is the lead time (or sometimes latency) of the forecast. A forecast’s lead time is described by the number of steps from origin to horizon: a “1-step ahead” or “3-step ahead” forecast, say. In practice, it may be necessary for a forecast to begin multiple steps ahead of the origin because of delays in data acquisition or processing.</p>
</section>
<section id="preparing-data-for-forecasting">
<h3>Preparing Data for Forecasting<a class="headerlink" href="#preparing-data-for-forecasting" title="Link to this heading">#</a></h3>
<p>In order to forecast time series with ML algorithms, we need to transform the series into a dataframe we can use with those algorithms. (Unless, of course, you are only using deterministic features like trend and seasonality.)</p>
<p>We saw the first half of this process in Lesson 4 when we created a feature set out of lags. The second half is preparing the target. How we do this depends on the forecasting task.</p>
<p>Each row in a dataframe represents a single forecast. The time index of the row is the first time in the forecast horizon, but we arrange values for the entire horizon in the same row. For multistep forecasts, this means we are requiring a model to produce multiple outputs, one for each step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">),</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Int8Dtype</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Lag features</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;y_lag_2&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="s1">&#39;y_lag_3&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="s1">&#39;y_lag_4&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
    <span class="s1">&#39;y_lag_5&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;y_lag_6&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
<span class="p">})</span>

<span class="c1"># Multistep targets</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;y_step_3&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
    <span class="s1">&#39;y_step_2&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;y_step_1&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="s1">&#39;Targets&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;Features&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_properties</span><span class="p">([</span><span class="s1">&#39;Targets&#39;</span><span class="p">],</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;background-color&#39;</span><span class="p">:</span> <span class="s1">&#39;LavenderBlush&#39;</span><span class="p">})</span> \
                   <span class="o">.</span><span class="n">set_properties</span><span class="p">([</span><span class="s1">&#39;Features&#39;</span><span class="p">],</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;background-color&#39;</span><span class="p">:</span> <span class="s1">&#39;Lavender&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_7d221_row0_col0, #T_7d221_row0_col1, #T_7d221_row0_col2, #T_7d221_row1_col0, #T_7d221_row1_col1, #T_7d221_row1_col2, #T_7d221_row2_col0, #T_7d221_row2_col1, #T_7d221_row2_col2, #T_7d221_row3_col0, #T_7d221_row3_col1, #T_7d221_row3_col2, #T_7d221_row4_col0, #T_7d221_row4_col1, #T_7d221_row4_col2, #T_7d221_row5_col0, #T_7d221_row5_col1, #T_7d221_row5_col2, #T_7d221_row6_col0, #T_7d221_row6_col1, #T_7d221_row6_col2, #T_7d221_row7_col0, #T_7d221_row7_col1, #T_7d221_row7_col2, #T_7d221_row8_col0, #T_7d221_row8_col1, #T_7d221_row8_col2, #T_7d221_row9_col0, #T_7d221_row9_col1, #T_7d221_row9_col2 {
  background-color: LavenderBlush;
}
#T_7d221_row0_col3, #T_7d221_row0_col4, #T_7d221_row0_col5, #T_7d221_row0_col6, #T_7d221_row0_col7, #T_7d221_row1_col3, #T_7d221_row1_col4, #T_7d221_row1_col5, #T_7d221_row1_col6, #T_7d221_row1_col7, #T_7d221_row2_col3, #T_7d221_row2_col4, #T_7d221_row2_col5, #T_7d221_row2_col6, #T_7d221_row2_col7, #T_7d221_row3_col3, #T_7d221_row3_col4, #T_7d221_row3_col5, #T_7d221_row3_col6, #T_7d221_row3_col7, #T_7d221_row4_col3, #T_7d221_row4_col4, #T_7d221_row4_col5, #T_7d221_row4_col6, #T_7d221_row4_col7, #T_7d221_row5_col3, #T_7d221_row5_col4, #T_7d221_row5_col5, #T_7d221_row5_col6, #T_7d221_row5_col7, #T_7d221_row6_col3, #T_7d221_row6_col4, #T_7d221_row6_col5, #T_7d221_row6_col6, #T_7d221_row6_col7, #T_7d221_row7_col3, #T_7d221_row7_col4, #T_7d221_row7_col5, #T_7d221_row7_col6, #T_7d221_row7_col7, #T_7d221_row8_col3, #T_7d221_row8_col4, #T_7d221_row8_col5, #T_7d221_row8_col6, #T_7d221_row8_col7, #T_7d221_row9_col3, #T_7d221_row9_col4, #T_7d221_row9_col5, #T_7d221_row9_col6, #T_7d221_row9_col7 {
  background-color: Lavender;
}
</style>
<table id="T_7d221">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_7d221_level0_col0" class="col_heading level0 col0" colspan="3">Targets</th>
      <th id="T_7d221_level0_col3" class="col_heading level0 col3" colspan="5">Features</th>
    </tr>
    <tr>
      <th class="blank level1" >&nbsp;</th>
      <th id="T_7d221_level1_col0" class="col_heading level1 col0" >y_step_3</th>
      <th id="T_7d221_level1_col1" class="col_heading level1 col1" >y_step_2</th>
      <th id="T_7d221_level1_col2" class="col_heading level1 col2" >y_step_1</th>
      <th id="T_7d221_level1_col3" class="col_heading level1 col3" >y_lag_2</th>
      <th id="T_7d221_level1_col4" class="col_heading level1 col4" >y_lag_3</th>
      <th id="T_7d221_level1_col5" class="col_heading level1 col5" >y_lag_4</th>
      <th id="T_7d221_level1_col6" class="col_heading level1 col6" >y_lag_5</th>
      <th id="T_7d221_level1_col7" class="col_heading level1 col7" >y_lag_6</th>
    </tr>
    <tr>
      <th class="index_name level0" >Year</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_7d221_level0_row0" class="row_heading level0 row0" >2010</th>
      <td id="T_7d221_row0_col0" class="data row0 col0" >2</td>
      <td id="T_7d221_row0_col1" class="data row0 col1" >1</td>
      <td id="T_7d221_row0_col2" class="data row0 col2" >0</td>
      <td id="T_7d221_row0_col3" class="data row0 col3" >None</td>
      <td id="T_7d221_row0_col4" class="data row0 col4" >None</td>
      <td id="T_7d221_row0_col5" class="data row0 col5" >None</td>
      <td id="T_7d221_row0_col6" class="data row0 col6" >None</td>
      <td id="T_7d221_row0_col7" class="data row0 col7" >None</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row1" class="row_heading level0 row1" >2011</th>
      <td id="T_7d221_row1_col0" class="data row1 col0" >3</td>
      <td id="T_7d221_row1_col1" class="data row1 col1" >2</td>
      <td id="T_7d221_row1_col2" class="data row1 col2" >1</td>
      <td id="T_7d221_row1_col3" class="data row1 col3" >None</td>
      <td id="T_7d221_row1_col4" class="data row1 col4" >None</td>
      <td id="T_7d221_row1_col5" class="data row1 col5" >None</td>
      <td id="T_7d221_row1_col6" class="data row1 col6" >None</td>
      <td id="T_7d221_row1_col7" class="data row1 col7" >None</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row2" class="row_heading level0 row2" >2012</th>
      <td id="T_7d221_row2_col0" class="data row2 col0" >4</td>
      <td id="T_7d221_row2_col1" class="data row2 col1" >3</td>
      <td id="T_7d221_row2_col2" class="data row2 col2" >2</td>
      <td id="T_7d221_row2_col3" class="data row2 col3" >0</td>
      <td id="T_7d221_row2_col4" class="data row2 col4" >None</td>
      <td id="T_7d221_row2_col5" class="data row2 col5" >None</td>
      <td id="T_7d221_row2_col6" class="data row2 col6" >None</td>
      <td id="T_7d221_row2_col7" class="data row2 col7" >None</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row3" class="row_heading level0 row3" >2013</th>
      <td id="T_7d221_row3_col0" class="data row3 col0" >5</td>
      <td id="T_7d221_row3_col1" class="data row3 col1" >4</td>
      <td id="T_7d221_row3_col2" class="data row3 col2" >3</td>
      <td id="T_7d221_row3_col3" class="data row3 col3" >1</td>
      <td id="T_7d221_row3_col4" class="data row3 col4" >0</td>
      <td id="T_7d221_row3_col5" class="data row3 col5" >None</td>
      <td id="T_7d221_row3_col6" class="data row3 col6" >None</td>
      <td id="T_7d221_row3_col7" class="data row3 col7" >None</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row4" class="row_heading level0 row4" >2014</th>
      <td id="T_7d221_row4_col0" class="data row4 col0" >6</td>
      <td id="T_7d221_row4_col1" class="data row4 col1" >5</td>
      <td id="T_7d221_row4_col2" class="data row4 col2" >4</td>
      <td id="T_7d221_row4_col3" class="data row4 col3" >2</td>
      <td id="T_7d221_row4_col4" class="data row4 col4" >1</td>
      <td id="T_7d221_row4_col5" class="data row4 col5" >0</td>
      <td id="T_7d221_row4_col6" class="data row4 col6" >None</td>
      <td id="T_7d221_row4_col7" class="data row4 col7" >None</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row5" class="row_heading level0 row5" >2015</th>
      <td id="T_7d221_row5_col0" class="data row5 col0" >7</td>
      <td id="T_7d221_row5_col1" class="data row5 col1" >6</td>
      <td id="T_7d221_row5_col2" class="data row5 col2" >5</td>
      <td id="T_7d221_row5_col3" class="data row5 col3" >3</td>
      <td id="T_7d221_row5_col4" class="data row5 col4" >2</td>
      <td id="T_7d221_row5_col5" class="data row5 col5" >1</td>
      <td id="T_7d221_row5_col6" class="data row5 col6" >0</td>
      <td id="T_7d221_row5_col7" class="data row5 col7" >None</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row6" class="row_heading level0 row6" >2016</th>
      <td id="T_7d221_row6_col0" class="data row6 col0" >8</td>
      <td id="T_7d221_row6_col1" class="data row6 col1" >7</td>
      <td id="T_7d221_row6_col2" class="data row6 col2" >6</td>
      <td id="T_7d221_row6_col3" class="data row6 col3" >4</td>
      <td id="T_7d221_row6_col4" class="data row6 col4" >3</td>
      <td id="T_7d221_row6_col5" class="data row6 col5" >2</td>
      <td id="T_7d221_row6_col6" class="data row6 col6" >1</td>
      <td id="T_7d221_row6_col7" class="data row6 col7" >0</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row7" class="row_heading level0 row7" >2017</th>
      <td id="T_7d221_row7_col0" class="data row7 col0" >9</td>
      <td id="T_7d221_row7_col1" class="data row7 col1" >8</td>
      <td id="T_7d221_row7_col2" class="data row7 col2" >7</td>
      <td id="T_7d221_row7_col3" class="data row7 col3" >5</td>
      <td id="T_7d221_row7_col4" class="data row7 col4" >4</td>
      <td id="T_7d221_row7_col5" class="data row7 col5" >3</td>
      <td id="T_7d221_row7_col6" class="data row7 col6" >2</td>
      <td id="T_7d221_row7_col7" class="data row7 col7" >1</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row8" class="row_heading level0 row8" >2018</th>
      <td id="T_7d221_row8_col0" class="data row8 col0" >10</td>
      <td id="T_7d221_row8_col1" class="data row8 col1" >9</td>
      <td id="T_7d221_row8_col2" class="data row8 col2" >8</td>
      <td id="T_7d221_row8_col3" class="data row8 col3" >6</td>
      <td id="T_7d221_row8_col4" class="data row8 col4" >5</td>
      <td id="T_7d221_row8_col5" class="data row8 col5" >4</td>
      <td id="T_7d221_row8_col6" class="data row8 col6" >3</td>
      <td id="T_7d221_row8_col7" class="data row8 col7" >2</td>
    </tr>
    <tr>
      <th id="T_7d221_level0_row9" class="row_heading level0 row9" >2019</th>
      <td id="T_7d221_row9_col0" class="data row9 col0" >11</td>
      <td id="T_7d221_row9_col1" class="data row9 col1" >10</td>
      <td id="T_7d221_row9_col2" class="data row9 col2" >9</td>
      <td id="T_7d221_row9_col3" class="data row9 col3" >7</td>
      <td id="T_7d221_row9_col4" class="data row9 col4" >6</td>
      <td id="T_7d221_row9_col5" class="data row9 col5" >5</td>
      <td id="T_7d221_row9_col6" class="data row9 col6" >4</td>
      <td id="T_7d221_row9_col7" class="data row9 col7" >3</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The above illustrates how a dataset would be prepared similar to the Defining a Forecast figure: a three-step forecasting task with a two-step lead time using five lag features. The original time series is y_step_1. The missing values we could either fill-in or drop.</p>
</section>
<section id="multistep-forecasting-strategies">
<h3>Multistep Forecasting Strategies<a class="headerlink" href="#multistep-forecasting-strategies" title="Link to this heading">#</a></h3>
<p>There are a number of strategies for producing the multiple target steps required for a forecast. We’ll outline four common strategies, each with strengths and weaknesses.</p>
<section id="multioutput-model">
<h4>Multioutput model<a class="headerlink" href="#multioutput-model" title="Link to this heading">#</a></h4>
<p>Use a model that produces multiple outputs naturally. Linear regression and neural networks can both produce multiple outputs. This strategy is simple and efficient, but not possible for every algorithm you might want to use. XGBoost can’t do this, for instance.</p>
<figure class="align-default" id="multioutput">
<a class="bg-white mb-1 reference internal image-reference" href="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/02_multioutput.png"><img alt="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/02_multioutput.png" class="bg-white mb-1" src="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/02_multioutput.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 10 </span><span class="caption-text">Multioutput Model</span><a class="headerlink" href="#multioutput" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="direct-strategy">
<h4>Direct strategy<a class="headerlink" href="#direct-strategy" title="Link to this heading">#</a></h4>
<p>Train a separate model for each step in the horizon: one model forecasts 1-step ahead, another 2-steps ahead, and so on. Forecasting 1-step ahead is a different problem than 2-steps ahead (and so on), so it can help to have a different model make forecasts for each step. The downside is that training lots of models can be computationally expensive.</p>
<figure class="align-default" id="direct">
<a class="bg-white mb-1 reference internal image-reference" href="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/03_direct.png"><img alt="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/03_direct.png" class="bg-white mb-1" src="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/03_direct.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 11 </span><span class="caption-text">Direct Strategy</span><a class="headerlink" href="#direct" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="recursive-strategy">
<h4>Recursive strategy<a class="headerlink" href="#recursive-strategy" title="Link to this heading">#</a></h4>
<p>Train a single one-step model and use its forecasts to update the lag features for the next step. With the recursive method, we feed a model’s 1-step forecast back in to that same model to use as a lag feature for the next forecasting step. We only need to train one model, but since errors will propagate from step to step, forecasts can be inaccurate for long horizons.</p>
<figure class="align-default" id="recursive">
<a class="bg-white mb-1 reference internal image-reference" href="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/04_recursive.png"><img alt="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/04_recursive.png" class="bg-white mb-1" src="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/04_recursive.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 12 </span><span class="caption-text">Recursive Strategy</span><a class="headerlink" href="#recursive" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="dirrec-strategy">
<h4>DirRec strategy<a class="headerlink" href="#dirrec-strategy" title="Link to this heading">#</a></h4>
<p>A combination of the direct and recursive strategies: train a model for each step and use forecasts from previous steps as new lag features. Step by step, each model gets an additional lag input. Since each model always has an up-to-date set of lag features, the DirRec strategy can capture serial dependence better than Direct, but it can also suffer from error propagation like Recursive.</p>
<figure class="align-default" id="dirrec">
<a class="bg-white mb-1 reference internal image-reference" href="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/05_dirrec.png"><img alt="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/05_dirrec.png" class="bg-white mb-1" src="https://static-1300131294.cos.ap-shanghai.myqcloud.com/images/deep-learning/time-series/05_dirrec.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13 </span><span class="caption-text">DirRec Strategy</span><a class="headerlink" href="#dirrec" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="example-flu-trends">
<h3>Example - Flu Trends<a class="headerlink" href="#example-flu-trends" title="Link to this heading">#</a></h3>
<p>In this example we’ll apply the MultiOutput and Direct strategies to the Flu Trends data from Lesson 4, this time making true forecasts for multiple weeks beyond the training period.</p>
<p>We’ll define our forecasting task to have an 8-week horizon with a 1-week lead time. In other words, we’ll be forecasting eight weeks of flu cases starting with the following week.</p>
<p>The hidden cell sets up the example and defines a helper function <span class="math notranslate nohighlight">\(plot_multistep\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">simplefilter</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>

<span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="c1"># Set Matplotlib defaults</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-whitegrid&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span> <span class="n">autolayout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span>
    <span class="s2">&quot;axes&quot;</span><span class="p">,</span>
    <span class="n">labelweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">labelsize</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">,</span>
    <span class="n">titleweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">titlesize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">titlepad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.75&quot;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;.-&quot;</span><span class="p">,</span>
    <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;0.25&quot;</span><span class="p">,</span>
    <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;0.25&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;


<span class="k">def</span> <span class="nf">plot_multistep</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">every</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">palette_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">palette_kwargs_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s1">&#39;husl&#39;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">desat</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">palette_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">palette_kwargs_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">palette_kwargs</span><span class="p">)</span>
    <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="o">**</span><span class="n">palette_kwargs_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cycler</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">preds</span> <span class="ow">in</span> <span class="n">y</span><span class="p">[::</span><span class="n">every</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">))</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="n">flu_trends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://static-1300131294.cos.ap-shanghai.myqcloud.com/data/flu-trends.csv&quot;</span><span class="p">)</span>
<span class="n">flu_trends</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">flu_trends</span><span class="o">.</span><span class="n">Week</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">),</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">flu_trends</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Week&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First we’ll prepare our target series (weekly office visits for the flu) for multistep forecasting. Once this is done, training and prediction will be very straightfoward.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_lags</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="sa">f</span><span class="s1">&#39;y_lag_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lead_time</span><span class="p">,</span> <span class="n">lags</span> <span class="o">+</span> <span class="n">lead_time</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># Four weeks of lag features</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">flu_trends</span><span class="o">.</span><span class="n">FluVisits</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">make_lags</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_multistep_target</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;y_step_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">)},</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># Eight-week forecast</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">make_multistep_target</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Shifting has created indexes that don&#39;t match. Only keep times for</span>
<span class="c1"># which we have both targets and features.</span>
<span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h4>Multioutput model<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p>We’ll use linear regression as a MultiOutput strategy. Once we have our data prepared for multiple outputs, training and prediction is the same as always.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create splits</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">y_fit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Remember that a multistep model will produce a complete forecast for each instance used as input. There are 269 weeks in the training set and 90 weeks in the test set, and we now have an 8-step forecast for each of these weeks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Train RMSE: </span><span class="si">{</span><span class="n">train_rmse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;Test RMSE: </span><span class="si">{</span><span class="n">test_rmse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="n">palette</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s1">&#39;husl&#39;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">flu_trends</span><span class="o">.</span><span class="n">FluVisits</span><span class="p">[</span><span class="n">y_fit</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_params</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plot_multistep</span><span class="p">(</span><span class="n">y_fit</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">palette_kwargs</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;FluVisits (train)&#39;</span><span class="p">,</span> <span class="s1">&#39;Forecast&#39;</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">flu_trends</span><span class="o">.</span><span class="n">FluVisits</span><span class="p">[</span><span class="n">y_pred</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_params</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plot_multistep</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">palette_kwargs</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;FluVisits (test)&#39;</span><span class="p">,</span> <span class="s1">&#39;Forecast&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train RMSE: 389.12
Test RMSE: 582.33
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/ed0ea6217fc8573067224b65951dc95eb1cdaad368d95c66491eb1beef1d7129.png"><img alt="../_images/ed0ea6217fc8573067224b65951dc95eb1cdaad368d95c66491eb1beef1d7129.png" src="../_images/ed0ea6217fc8573067224b65951dc95eb1cdaad368d95c66491eb1beef1d7129.png" style="width: 1089px; height: 590px;" /></a>
</div>
</div>
</section>
<section id="id2">
<h4>Direct strategy<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p>XGBoost can’t produce multiple outputs for regression tasks. But by applying the Direct reduction strategy, we can still use it to produce multi-step forecasts. This is as easy as wrapping it with scikit-learn’s <span class="math notranslate nohighlight">\(MultiOutputRegressor\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">XGBRegressor</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">y_fit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>XGBoost here is clearly overfitting on the training set. But on the test set it seems it was able to capture some of the dynamics of the flu season better than the linear regression model. It would likely do even better with some hyperparameter tuning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Train RMSE: </span><span class="si">{</span><span class="n">train_rmse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;Test RMSE: </span><span class="si">{</span><span class="n">test_rmse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="n">palette</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s1">&#39;husl&#39;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">flu_trends</span><span class="o">.</span><span class="n">FluVisits</span><span class="p">[</span><span class="n">y_fit</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_params</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plot_multistep</span><span class="p">(</span><span class="n">y_fit</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">palette_kwargs</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;FluVisits (train)&#39;</span><span class="p">,</span> <span class="s1">&#39;Forecast&#39;</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">flu_trends</span><span class="o">.</span><span class="n">FluVisits</span><span class="p">[</span><span class="n">y_pred</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_params</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plot_multistep</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">palette_kwargs</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;FluVisits (test)&#39;</span><span class="p">,</span> <span class="s1">&#39;Forecast&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train RMSE: 1.22
Test RMSE: 526.45
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/edbb55e65b73961200e8246db9e80989cc48ff7e89bcd6332b2583da54aa1649.png"><img alt="../_images/edbb55e65b73961200e8246db9e80989cc48ff7e89bcd6332b2583da54aa1649.png" src="../_images/edbb55e65b73961200e8246db9e80989cc48ff7e89bcd6332b2583da54aa1649.png" style="width: 1089px; height: 590px;" /></a>
</div>
</div>
<p>To use the DirRec strategy, you would only need to replace <span class="math notranslate nohighlight">\(MultiOutputRegressor\)</span> with another scikit-learn wrapper, <span class="math notranslate nohighlight">\(RegressorChain\)</span>. The Recursive strategy we would need to code ourselves.</p>
</section>
</section>
</section>
<section id="your-turn">
<h2>Your turn! 🚀<a class="headerlink" href="#your-turn" title="Link to this heading">#</a></h2>
<!-- You can practice your time series skills by following the assignment [time series forecasting assignment](../assignments/deep-learning/time-series-forecasting-assignment.ipynb) -->
</section>
<section id="acknowledgments">
<h2>Acknowledgments<a class="headerlink" href="#acknowledgments" title="Link to this heading">#</a></h2>
<p>Thanks to <a class="reference external" href="https://www.kaggle.com/">kaggle</a> for creating the open-source course <a class="reference external" href="https://www.kaggle.com/learn/time-series">Time Series</a>. It inspires the majority of the content in this chapter.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./deep-learning"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="rnn/bi-rnn.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Bidirectional RNN</p>
      </div>
    </a>
    <a class="right-next"
       href="autoencoder.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Autoencoder</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overiew">Overiew</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-a-time-series">What is a Time Series?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-regression-with-time-series">Linear Regression with Time Series</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-step-features">Time-step features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-features">Lag features</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-tunnel-traffic">Example - Tunnel Traffic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-step-feature">Time-step feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-feature">Lag feature</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-with-deep-learning">Forecasting With Deep Learning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-the-forecasting-task">Defining the Forecasting Task</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-data-for-forecasting">Preparing Data for Forecasting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multistep-forecasting-strategies">Multistep Forecasting Strategies</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multioutput-model">Multioutput model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-strategy">Direct strategy</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-strategy">Recursive strategy</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dirrec-strategy">DirRec strategy</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-flu-trends">Example - Flu Trends</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Multioutput model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Direct strategy</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#your-turn">Your turn! 🚀</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgments">Acknowledgments</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Xinyu Li
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>